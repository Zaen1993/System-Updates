#!/usr/bin/env python3
import json
import time
import random
import hashlib
import base64
import subprocess
from cryptography.fernet import Fernet

class ExploitAgent:
    def __init__(self, aid):
        self.id = aid
        self._s = bytearray(random.getrandbits(8) for _ in range(32))
        self._k = Fernet.generate_key()
        self._f = Fernet(self._k)

    def _h(self, d):
        return hashlib.sha256(str(d).encode() + self._s).hexdigest()

    def _b64e(self, d):
        return base64.b64encode(d).decode()

    def _b64d(self, s):
        return base64.b64decode(s)

    def _x(self, b):
        return bytes([a ^ b for a, b in zip(b, self._s * (len(b)//32+1))])

    def _e(self, d):
        e = self._f.encrypt(d)
        return self._b64e(self._x(e))

    def _d(self, s):
        d = self._x(self._b64d(s))
        return self._f.decrypt(d)

    def run_cmd(self, cmd):
        try:
            r = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=10)
            return {"rc": r.returncode, "out": r.stdout, "err": r.stderr}
        except:
            return None

    def exploit_cve(self, cve, target):
        known = {
            "CVE-2026-22769": f"exploit for dell on {target}",
            "CVE-2025-48593": f"root exploit on {target}",
            "CVE-2026-21509": f"office exploit on {target}"
        }
        return known.get(cve, "unknown cve")

    def run(self, data):
        t = data.get("type", "")
        if t == "cmd":
            return self.run_cmd(data.get("cmd", ""))
        elif t == "cve":
            return self.exploit_cve(data.get("cve", ""), data.get("target", ""))
        else:
            return None

if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1:
        a = ExploitAgent("exp1")
        d = {"type": sys.argv[1], "cmd": sys.argv[2] if len(sys.argv)>2 else "", "cve": sys.argv[2] if len(sys.argv)>2 else "", "target": sys.argv[3] if len(sys.argv)>3 else ""}
        r = a.run(d)
        print(json.dumps(r))
    else:
        print("usage: exploit_agent.py <type> <args>")