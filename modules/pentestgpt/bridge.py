#!/usr/bin/env python3
import json
import time
import random
import hashlib
import base64
import requests
from cryptography.fernet import Fernet

class PentestGPTBridge:
    def __init__(self, api_key=None, model="gpt-4"):
        self._s = bytearray(random.getrandbits(8) for _ in range(32))
        self._k = Fernet.generate_key()
        self._f = Fernet(self._k)
        self.api_key = api_key
        self.model = model
        self._c = []

    def _h(self, d):
        return hashlib.sha256(str(d).encode() + self._s).hexdigest()

    def _b64e(self, d):
        return base64.b64encode(d).decode()

    def _b64d(self, s):
        return base64.b64decode(s)

    def _x(self, b):
        return bytes([a ^ b for a, b in zip(b, self._s * (len(b)//32+1))])

    def _e(self, d):
        e = self._f.encrypt(d)
        return self._b64e(self._x(e))

    def _d(self, s):
        d = self._x(self._b64d(s))
        return self._f.decrypt(d)

    def ask(self, prompt, system=None):
        headers = {"Authorization": f"Bearer {self.api_key}", "Content-Type": "application/json"}
        messages = []
        if system:
            messages.append({"role": "system", "content": system})
        messages.append({"role": "user", "content": prompt})
        payload = {"model": self.model, "messages": messages, "temperature": 0.7}
        try:
            r = requests.post("https://api.openai.com/v1/chat/completions", headers=headers, json=payload, timeout=30)
            if r.status_code == 200:
                resp = r.json()
                answer = resp["choices"][0]["message"]["content"]
                cid = self._h(prompt + str(time.time()))
                self._c.append({"id": cid, "prompt": prompt, "answer": answer})
                return answer
            else:
                return f"Error: {r.status_code}"
        except Exception as e:
            return f"Exception: {e}"

    def history(self):
        return self._c

    def encrypt_chat(self, chat_id):
        for c in self._c:
            if c["id"] == chat_id:
                return self._e(json.dumps(c).encode())
        return None

    def decrypt_chat(self, enc):
        return json.loads(self._d(enc).decode())

if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1:
        gpt = PentestGPTBridge(api_key="YOUR_API_KEY")
        ans = gpt.ask(" ".join(sys.argv[1:]))
        print(ans)
    else:
        print("Usage: bridge.py <prompt>")